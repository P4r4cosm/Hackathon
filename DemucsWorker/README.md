# FlaskServise

Этот сервис представляет собой Flask-приложение, предназначенное для обработки аудиофайлов с целью выделения вокальной дорожки.

## Логика работы (с использованием Docker для Demucs)

Сервис `FlaskServise` и обработчик `Demucs` работают в связке с использованием Docker.
Предполагается, что Docker-образ для `Demucs` (именуемый `local/demucs_app`) уже собран (например, из директории `../demucs` вашего проекта).
Обмен файлами между `FlaskServise` и временными контейнерами `Demucs` происходит через общую директорию на хост-машине.

1.  **Настройка общей директории**:
    *   В `FlaskServise/app.py` определена переменная `HOST_SHARED_DIR_PATH` (например, `E:/hacaton/git/Hackathon/shared_docker_data`). Эта директория должна существовать на хост-машине.
    *   Эта директория будет монтироваться как volume и в контейнер `FlaskServise` (в `/shared_host_mount`), и во временные контейнеры `Demucs` (в `/data_mount`).

2.  **Прием файла**:
    *   Сервис `FlaskServise` ожидает POST-запрос на эндпоинт `/process_song`.
    *   В теле запроса должен находиться аудиофайл (`.wav` или `.flac`) под ключом `file`.

3.  **Сохранение файла**:
    *   Полученный аудиофайл сохраняется `FlaskServise` в поддиректорию `input_files` внутри общей директории на хосте.
    *   Например, если `HOST_SHARED_DIR_PATH` это `E:/hacaton/git/Hackathon/shared_docker_data`, файл будет сохранен как `E:/hacaton/git/Hackathon/shared_docker_data/input_files/<filename>`.

4.  **Обработка с помощью Demucs во временном Docker-контейнере**:
    *   Для каждого запроса `FlaskServise` запускает новый временный Docker-контейнер из образа `local/demucs_app` командой `docker run --rm ...`.
    *   В этот временный контейнер монтируются:
        *   Общая директория с хоста (например, `E:/hacaton/git/Hackathon/shared_docker_data`) в `/data_mount` внутри контейнера `Demucs`.
        *   Именованный Docker-том `demucs_models_cache` в `/data/models` (для кэширования моделей Demucs).
    *   Внутри временного контейнера `Demucs` выполняется команда:
        ```bash
        python3 -m demucs -n htdemucs_ft --two-stems vocals --shifts 1 --overlap 0.3 --out /data_mount/output_files /data_mount/input_files/<filename>
        ```
        (где `<filename>` - имя загруженного файла).
    *   `Demucs` обрабатывает файл, находящийся в `/data_mount/input_files/`, и сохраняет результат в `/data_mount/output_files/htdemucs_ft/<track_name_without_ext>/vocals.wav` (пути внутри контейнера `Demucs`).

5.  **Отправка результата**:
    *   После завершения работы временного контейнера `Demucs`, `FlaskServise` ищет обработанный файл `vocals.wav`.
    *   Путь поиска внутри контейнера `FlaskServise`: `/shared_host_mount/output_files/htdemucs_ft/<track_name_without_ext>/vocals.wav`.
    *   Это соответствует файлу на хосте: `E:/hacaton/git/Hackathon/shared_docker_data/output_files/htdemucs_ft/<track_name_without_ext>/vocals.wav`.
    *   Найденный файл `vocals.wav` отправляется клиенту в качестве ответа.

6.  **Обработка ошибок**: Сервис обрабатывает различные сценарии ошибок, включая отсутствие файла, неверный тип файла, ошибки во время выполнения `docker run` для `Demucs`, или если файл с вокалом не найден после обработки.

7.  **Очистка**: Временный контейнер `Demucs` автоматически удаляется после завершения работы благодаря флагу `--rm` в команде `docker run`. Входные и выходные файлы в общей директории на хосте по умолчанию не удаляются автоматически (это можно изменить в `app.py` при необходимости).

8.  **Запуск FlaskServise**: Сервис `FlaskServise` (при запуске, например, через `docker-compose up` или `docker run`) также монтирует `HOST_SHARED_DIR_PATH` в `/shared_host_mount` и запускается на порту `5000`.

## Зависимости

Основные зависимости указаны в файле `requirements.txt`. Кроме того, для корректной работы сервиса необходима настроенная среда `Demucs` в директории, расположенной на один уровень выше директории `FlaskServise` и называющейся `demucs`.

## Эндпоинты

*   `POST /process_song`
    *   **Описание**: Загружает аудиофайл для выделения вокала.
    *   **Тело запроса**: `multipart/form-data` с полем `file`, содержащим аудиофайл (`.wav` или `.flac`).
    *   **Успешный ответ (200 OK)**: Файл `vocals.wav`.
    *   **Ошибки**:
        *   `400 Bad Request`: Если файл не предоставлен, не выбран или имеет недопустимое расширение.
        *   `500 Internal Server Error`: В случае ошибок при обработке файла с помощью `Demucs` или если файл с вокалом не найден после обработки. 

## Docker

Для сборки и запуска сервиса с использованием Docker выполните следующие шаги:

1.  **Структура проекта**:
    Убедитесь, что ваш проект имеет следующую структуру:
    ```
    your-project-root/
    ├── demucs/               # Директория с проектом Demucs
    └── FlaskServise/         # Директория с этим Flask-сервисом
        ├── app.py
        ├── requirements.txt
        ├── Dockerfile
        └── README.md
    ```

2.  **Сборка Docker-образа**:
    Откройте терминал в директории `FlaskServise` и выполните команду:
    ```bash
    docker build -t flask-demucs-service .
    ```
    Эта команда соберет образ, включив в него содержимое директории `FlaskServise` и директории `../demucs`.

3.  **Запуск Docker-контейнера**:
    После успешной сборки образа, запустите контейнер:
    ```bash
    docker run -p 5000:5000 flask-demucs-service
    ```
    *   `-p 5000:5000`: Пробрасывает порт 5000 контейнера на порт 5000 хост-машины.

    **Примечание**: Директория `demucs` со всем ее содержимым (включая `Makefile` и необходимые модели, например, `htdemucs_ft`) будет скопирована внутрь Docker-образа. Убедитесь, что она содержит все необходимое для выполнения команды `make run ...`, которую использует `app.py`.

    После запуска контейнера сервис будет доступен по адресу `http://localhost:5000/process_song`. 