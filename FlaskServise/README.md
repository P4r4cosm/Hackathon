# FlaskServise

Этот сервис представляет собой Flask-приложение, предназначенное для обработки аудиофайлов с целью выделения вокальной дорожки.

## Логика работы

1.  **Прием файла**: Сервис ожидает POST-запрос на эндпоинт `/process_song`. В теле запроса должен находиться аудиофайл (`.wav` или `.flac`) под ключом `file`.
2.  **Сохранение файла**: Полученный аудиофайл временно сохраняется в директорию `<корень_проекта_demucs>/input/`.
3.  **Обработка с помощью Demucs**:
    *   Сервис вызывает команду `make run track=<имя_файла> model=htdemucs_ft splittrack=vocals shifts=2 overlap=0.3` в директории `../demucs` (относительно расположения `app.py`).
    *   Предполагается, что `Demucs` — это инструмент для разделения источников звука, и в данном случае он используется для извлечения вокала (`splittrack=vocals`).
4.  **Отправка результата**:
    *   В случае успешной обработки, сервис ищет файл `vocals.wav` в директории `<корень_проекта_demucs>/output/htdemucs_ft/<имя_трека_без_расширения>/`.
    *   Найденный файл `vocals.wav` отправляется клиенту в качестве ответа.
5.  **Обработка ошибок**: Сервис обрабатывает различные сценарии ошибок, включая:
    *   Отсутствие файла в запросе.
    *   Недопустимый тип файла.
    *   Ошибки во время выполнения команды `Demucs`.
    *   Отсутствие ожидаемого файла `vocals.wav` после обработки.
6.  **Очистка**: Временный входной файл удаляется из директории `<корень_проекта_demucs>/input/` после завершения обработки (как успешной, так и неуспешной).
7.  **Запуск**: По умолчанию сервис запускается на `0.0.0.0:5000` в режиме отладки.

## Зависимости

Основные зависимости указаны в файле `requirements.txt`. Кроме того, для корректной работы сервиса необходима настроенная среда `Demucs` в директории, расположенной на один уровень выше директории `FlaskServise` и называющейся `demucs`.

## Эндпоинты

*   `POST /process_song`
    *   **Описание**: Загружает аудиофайл для выделения вокала.
    *   **Тело запроса**: `multipart/form-data` с полем `file`, содержащим аудиофайл (`.wav` или `.flac`).
    *   **Успешный ответ (200 OK)**: Файл `vocals.wav`.
    *   **Ошибки**:
        *   `400 Bad Request`: Если файл не предоставлен, не выбран или имеет недопустимое расширение.
        *   `500 Internal Server Error`: В случае ошибок при обработке файла с помощью `Demucs` или если файл с вокалом не найден после обработки. 

## Docker

Для сборки и запуска сервиса с использованием Docker выполните следующие шаги:

1.  **Структура проекта**:
    Убедитесь, что ваш проект имеет следующую структуру:
    ```
    your-project-root/
    ├── demucs/               # Директория с проектом Demucs
    └── FlaskServise/         # Директория с этим Flask-сервисом
        ├── app.py
        ├── requirements.txt
        ├── Dockerfile
        └── README.md
    ```

2.  **Сборка Docker-образа**:
    Откройте терминал в директории `FlaskServise` и выполните команду:
    ```bash
    docker build -t flask-demucs-service .
    ```
    Эта команда соберет образ, включив в него содержимое директории `FlaskServise` и директории `../demucs`.

3.  **Запуск Docker-контейнера**:
    После успешной сборки образа, запустите контейнер:
    ```bash
    docker run -p 5000:5000 flask-demucs-service
    ```
    *   `-p 5000:5000`: Пробрасывает порт 5000 контейнера на порт 5000 хост-машины.

    **Примечание**: Директория `demucs` со всем ее содержимым (включая `Makefile` и необходимые модели, например, `htdemucs_ft`) будет скопирована внутрь Docker-образа. Убедитесь, что она содержит все необходимое для выполнения команды `make run ...`, которую использует `app.py`.

    После запуска контейнера сервис будет доступен по адресу `http://localhost:5000/process_song`. 